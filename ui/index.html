<!DOCTYPE html>
<html>
<head>
<title>Mage Knight</title>
<script src="jquery.js"></script>
<script>


function tileUrl(ty,n ) { return '/img/maps/' + ty + '/' + n + '.png'; }
function charUrl(ch,ty) { return '/img/characters/' + ch + '/' + ty + '.png'; }
function enemyUrl(ty,ch) { return '/img/enemies/' + ty + '/' + ch + '.png'; }

var maxX         = 10;
var maxY         = 10;
var tileWidth    = 200;
var enemyWidth   = Math.floor(tileWidth / 4);
var charWidth    = Math.floor(tileWidth / 6);
var hexWidth     = tileWidth / 3;
var centerToSide = hexWidth / 2;
var hexSide      = centerToSide / Math.sin(Math.PI/ 3);
var hexHeight    = 2 * hexSide;
var x_off        = maxX * centerToSide;
var y_off        = maxY * 4.5 * hexSide;

function tilePos(x,y) {
  return { left: x_off + x * 2 * hexWidth - y * centerToSide
         , top:  y_off - x * 3 * hexSide  - y * 4.5 * hexSide
         };
}

function hexLocation(x, y, dir) {
  var coords = tilePos(x,y);
  var dX, dY;
  switch(dir) {
    case 'NW': dX = 1; dY = 0; break;
    case 'NE': dX = 3; dY = 0; break;
    case 'W' : dX = 0; dY = 1; break;
    case 'C' : dX = 2; dY = 1; break;
    case 'E' : dX = 4; dY = 1; break;
    case 'SW': dX = 1; dY = 2; break;
    case 'SE': dX = 3; dY = 2; break;
  }
  return { top:  coords.top  + dY * 1.5 * hexSide
         , left: coords.left + dX * centerToSide
         };
}

function positionItem(item, x, y, dir) {
  var c = hexLocation(x,y,dir);
  item.css('left', c.left + (hexWidth  - item.width()) / 2)
      .css('top',  c.top  + (hexHeight - item.height()) / 2);
}


function drawTile(ty,n,x,y) {

  var coords = tilePos(x,y);
  var left   = coords.left;
  var top    = coords.top;

  var img = $('<img/>').css('position','absolute')
                       .width(tileWidth)
                       .css('left', left)
                       .css('top',top);

  img.click(function(ev) {
    var off = img.offset();
    var imX = ev.pageX - off.left;
    var imY = ev.pageY - off.top;

    var rectX   = hexWidth;
    var rectY   = 1.5 * hexSide;

    var row    = Math.floor(imY / rectY);
    var clickY = imY - row * rectY;
    var even   = row % 2 === 0;
    if (even) imX += centerToSide;

    var col    = Math.floor(imX / rectX);
    var clickX = imX - col * rectX;

    if (clickY < hexSide / 2)
      var smllPart = hexSide / 2;
      var slope = smllPart / centerToSide;
      if (clickX < centerToSide) {
        if (clickY < smllPart - clickX * slope) {
          --row;
          if (even) --col;
        }
      } else {
        clickX -= centerToSide;
        if (clickY < clickX * slope) {
          --row;
          if (!even) ++col;
        }
      }
    ++row;

    var table = [ [ [0,1,'SW'],  [0,1,'SE'], [1,1,'W'] ]
                , [ [-1,1,'E'],  [0,0,'NW'], [0,0,'NE'],[1,0,'SW'] ]
                , [ [0,0,'W'],   [0,0,'C'],  [0,0,'E'] ]
                , [ [-1,0,'NE'], [0,0,'SW'], [0,0,'SE'],[1,-1,'W'] ]
                , [ [-1,0,'E'],  [0,-1,'NW'],[0,-1,'NE'] ]
                ]
    var diff = table[row][col];
    var cX = x + diff[0];
    var cY = y + diff[1];
    var dir = diff[2];
    if (cX >= 0 && cY >= 0) tileClicked(cX,cY,dir);
  });



  var imgs = [ img ];
  if (x == 0) imgs.push(drawTile('basic','border-left',-1,y+1)[0])
  if (y == 0) imgs.push(drawTile('basic','border-bottom',x+1,-1)[0]);

  img.attr('src',tileUrl(ty,n));
  return imgs;
}


function tileClicked(x,y,dir) {
  positionItem($('#char'), x, y, dir);
}




function cardImageUrl(cardName) {
  return '/img/cards/all/' + cardName + '.jpg';
}

function manaUrl(mana) {
  return '/img/mana/' + mana + '.jpg';
}

function drawSource(manas) {
  var source = $('<div/>');
  jQuery.each(manas, function(ix,mana) {
    var img = $('<img/>')
              .attr('src', manaUrl(mana))
              .css('display', 'inline-block')
              .css('box-shadow', '2px 2px 5px #ccc')
              .css('margin', '2px')
              .width('20px');
    source.append(img);
  });
  return source;
}

function drawHand(cards) {
  var hand = $('<div/>');
  jQuery.each(cards, function(ix,card) {
    var img = $('<img/>')
              .attr('src', cardImageUrl(card))
              .css('display', 'inline-block')
              .css('margin', '2px')
              .width('150px');
    img.hover( function () { img.width('250px'); }
             , function () { img.width('150px'); }
             );
    hand.append(img);
  });
  return hand;
}

$(document).ready(function() {
  var body = $('body');
  var div = $('<div/>')
            .css('position', 'relative')
            .css('left', '5px')
            .css('top', '5px')
            .css('border', '1px solid black')
            .css('width', '800px')
            .css('height', '600px')
            .css('overflow', 'auto')
            .css('background', 'black');

  var img;
  for (var i = 1; i < 2; ++i) {
    img = drawTile('basic',i == 0 ? 'A' : i,i,0);
    div.append(img)
  }

  for (var i = 0; i < 2; ++i) {
    img = drawTile('basic',i == 0 ? 'A' : i,0,i);
    div.append(img)
  }
  div.append(drawTile('basic',7,1,1));


  var it = $('<img/>')
           .attr('id','char')
           .css('position','absolute')
           .width(charWidth);

  div.append(it);

  it.load(function() { positionItem(it, 0, 1, 'SE'); });
  //it.attr('src', enemyUrl('orc','diggers'));
  it.attr('src', charUrl('arythea', 'art'));
  body.append(div);


});
</script>
</head>
<body>
</body>
</html>
