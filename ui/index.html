<!DOCTYPE html>
<html>
<head>
<title>Mage Knight</title>
<script src="jquery.js"></script>
<script>


function tileUrl(ty,n ) { return '/img/maps/' + ty + '/' + n + '.png'; }
function charUrl(ch,ty) { return '/img/characters/' + ch + '/' + ty + '.png'; }
function enemyUrl(ty,ch) { return '/img/enemies/' + ty + '/' + ch + '.png'; }
function manaUrl(mana) { return '/img/mana/' + mana + '.png'; }

function boardToken(wi,url) {
  return $('<img/>')
         .css('position', 'absolute')
         .css('width', wi + 'px')
         .attr('src', url);
}

function characterToken(m,ch) {
  return boardToken(m.charWidth, charUrl(ch,'figure'));
}

function shieldToken(m,ch) {
  return boardToken(m.shieldWidth, charUrl(ch,'shield'));
}

function enemyToken(m,ty,ch) {
  return boardToken(m.enemyWidth, enemyUrl(ty,ch));
}



function prepareMap(pMaxX, pMaxY, pTileWidth) {

  var tileWidth    = pTileWidth;
  var hexWidth     = tileWidth / 3;
  var enemyWidth   = 3 * hexWidth / 4;
  var charWidth    = hexWidth / 1.5;
  var shieldWidth  = hexWidth / 3;

  var centerToSide = hexWidth / 2;
  var hexSide      = centerToSide / Math.sin(Math.PI/ 3);
  var hexHeight    = 2 * hexSide;

  var maxX         = pMaxX;
  var maxY         = pMaxY;
  var x_off        = maxY * centerToSide;
  var y_off        = maxX * 3 * hexSide  + maxY * 4.5 * hexSide;

  return { tileWidth    : tileWidth
         , hexWidth     : hexWidth
         , enemyWidth   : enemyWidth
         , charWidth    : charWidth
         , shieldWidth  : shieldWidth

         , centerToSide : centerToSide
         , hexSide      : hexSide
         , hexHeight    : hexHeight

         , maxX         : maxX
         , maxY         : maxY
         , x_off        : x_off
         , y_off        : y_off
         };
}

function tilePos(m,x,y) {
  return { left: m.x_off + x * 2 * m.hexWidth - y * m.centerToSide
         , top:  m.y_off - x * 3 * m.hexSide  - y * 4.5 * m.hexSide
         };
}

function hexLocation(m, x, y, dir) {
  var coords = tilePos(m,x,y);
  var dX, dY;
  switch(dir) {
    case 'NW': dX = 1; dY = 0; break;
    case 'NE': dX = 3; dY = 0; break;
    case 'W' : dX = 0; dY = 1; break;
    case 'C' : dX = 2; dY = 1; break;
    case 'E' : dX = 4; dY = 1; break;
    case 'SW': dX = 1; dY = 2; break;
    case 'SE': dX = 3; dY = 2; break;
  }
  return { top:  coords.top  + dY * 1.5 * m.hexSide
         , left: coords.left + dX * m.centerToSide
         };
}

function positionItems(m, items, x, y, dir) {
  var c = hexLocation(m,x,y,dir);
  var hexCenter = c.left + m.hexWidth / 2;

  var totWidth = 0;
  jQuery.each(items,function(ix,item) { totWidth += item.width(); })

  var maxW = 1.5 * m.hexWidth;
  var scaling;
  if (totWidth > maxW) { scaling = maxW / totWidth; totWidth = maxW; }
  else scaling = 1;

  var left = hexCenter - totWidth / 2;

  jQuery.each(items,function(ix,item) {
    item.css('left', left)
        .css('top',  c.top  + (m.hexHeight - item.height()) / 2);
    left += item.width() * scaling;
  });

}




function drawTile(m, tile) {


  var x      = tile.x;
  var y      = tile.y;
  var coords = tilePos(m,x,y);
  var left   = coords.left;
  var top    = coords.top;

  var img = $('<img/>').css('position','absolute')
                       .width(m.tileWidth)
                       .height(m.tileWidth * 0.96)
                       .css('left', left)
                       .css('top',top);

  img.click(function(ev) {

    var off = img.offset();
    var imX = ev.pageX - off.left;
    var imY = ev.pageY - off.top;

    var rectX   = m.hexWidth;
    var rectY   = 1.5 * m.hexSide;

    var row    = Math.floor(imY / rectY);
    var clickY = imY - row * rectY;
    var even   = row % 2 === 0;
    if (even) imX += m.centerToSide;

    var col    = Math.floor(imX / rectX);
    var clickX = imX - col * rectX;

    if (clickY < m.hexSide / 2)
      var smllPart = m.hexSide / 2;
      var slope = smllPart / m.centerToSide;
      if (clickX < m.centerToSide) {
        if (clickY < smllPart - clickX * slope) {
          --row;
          if (even) --col;
        }
      } else {
        clickX -= m.centerToSide;
        if (clickY < clickX * slope) {
          --row;
          if (!even) ++col;
        }
      }
    ++row;

    var table = [ [ [0,1,'SW'],  [0,1,'SE'], [1,1,'W'] ]
                , [ [-1,1,'E'],  [0,0,'NW'], [0,0,'NE'],[1,0,'SW'] ]
                , [ [0,0,'W'],   [0,0,'C'],  [0,0,'E'] ]
                , [ [-1,0,'NE'], [0,0,'SW'], [0,0,'SE'],[1,-1,'W'] ]
                , [ [-1,0,'E'],  [0,-1,'NW'],[0,-1,'NE'] ]
                ]
    var diff = table[row][col];
    var cX = x + diff[0];
    var cY = y + diff[1];
    var dir = diff[2];
    if (cX >= 0 && cY >= 0) { return tileClicked(m,cX,cY,dir); return true; }
    return false;
  });


  var imgs = [ img ];
  if (x == 0) imgs.push(drawTile(m,{ ty: 'basic', name: 'border-left'
                                   , x: -1,y: y+1})[0]);
  if (y == 0) imgs.push(drawTile(m,{ ty: 'basic', name: 'border-bottom'
                                   , x: x+1, y: -1})[0]);

  img.attr('src',tileUrl(tile.ty,tile.name));
  return imgs;
}


function tileClicked(m,x,y,dir) {
  positionItems(m, tokens, x, y, dir);
}


function drawMap(map) {
  var div = $('<div/>')
            .css('position', 'relative')
            .css('width', '50%')
            .css('overflow', 'auto')
            .css('background', 'black');

  var maxX = 0;
  var maxY = 0;

  jQuery.each(map, function(ix,tile) {
    if (tile.x > maxX) maxX = tile.x;
    if (tile.y > maxY) maxY = tile.y;
  });

  var m = prepareMap(maxX,maxY,300);
  div.css('height', $(window).height() - 30);

  jQuery.each(map, function(ix,tile) {
    div.append(drawTile(m,tile));
  });

  return { dom: div, m: m };
}

function focusMap(m,map,x,y) {
  var c = tilePos(m,x,y);
  map.scrollTop(c.top).scrollLeft(c.left);
}




function drawSource(manas) {
  var source = $('<div/>');
  jQuery.each(manas, function(ix,mana) {
    var img = $('<img/>')
              .attr('src', manaUrl(mana))
              .css('display', 'inline-block')
              .css('box-shadow', '2px 2px 5px #ccc')
              .css('margin', '2px')
              .width('20px');
    source.append(img);
  });
  return source;
}

function sampleMap() {
  var tiles = [];

  for (var i = 0; i < 5; ++i)
    for (var j = 0; j < 5; ++j)
      tiles.push( { ty: 'basic'
                  , name: i == 0 && j == 0
                        ? 'A'
                        : Math.floor(1 + 11 * Math.random())
                  , x:i, y: j });

  return tiles;
}


$(document).ready(function() {
  var body = $('body');



  var mp = drawMap(sampleMap());
  var div = mp.dom.css('left', '5px')
                  .css('top', '5px');

  tokens = [ characterToken(mp.m, 'norowas')
           , enemyToken(mp.m, 'orc', 'diggers') /*

           , characterToken(mp.m, 'goldyx')
           , characterToken(mp.m, 'tovak')
           , characterToken(mp.m, 'arythea')


             shieldToken(mp.m, 'tovak')
           , shieldToken(mp.m, 'tovak') 
           , shieldToken(mp.m, 'tovak')
           , shieldToken(mp.m, 'tovak')
           , shieldToken(mp.m, 'tovak')
           , shieldToken(mp.m, 'goldyx')  */
           ];

  div.append(tokens);


  body.append(mp.dom);

  focusMap(mp.m, div,0,0);

});
</script>
</head>
<body>
</body>
</html>
